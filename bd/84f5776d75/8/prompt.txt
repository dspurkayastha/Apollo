Implement the following plan:

# Plan: Hero 3D Scene — Polished R3F Material Upgrade

## Context

The current hero uses React Three Fiber with programmatic geometry (Canvas2D textures on `planeGeometry`, `meshPhysicalMaterial` spheres, `ContactShadows`). The result looks "programmer-made" — flat pages with no visible edges, plastic-looking spheres, weak shadows. The mockup shows a polished, designer-quality composition with real paper depth, glass-like spheres, and soft natural shadows.

**5 alternatives were evaluated** (Spline, Blender GLB, static image, hybrid, improved R3F). The winner is **Enhanced R3F** — zero new dependencies (all utilities already in `@react-three/drei` ^10.7.7), keeps everything in code for fast hot-reload iteration, and uses proven drei components that the R3F showcase community relies on for polished results.

---

## File: `apps/web/components/landing/hero-3d-scene.tsx`

3 material/component swaps, no new packages.

### Change 1: Glass Spheres — `MeshTransmissionMaterial` + `transmissionSampler`

**Problem**: `meshPhysicalMaterial` with clearcoat looks like plastic — no refraction, no chromatic aberration.

**Fix**: Swap to drei's `MeshTransmissionMaterial` with `transmissionSampler` (shared Three.js internal buffer — 1 render pass for all 18 spheres, not 18 separate FBO passes).

```tsx
import { MeshTransmissionMaterial } from "@react-three/drei";

<MeshTransmissionMaterial
  transmissionSampler
  transmission={1}
  thickness={radius * 5}
  roughness={0.01}
  chromaticAberration={0.04}
  anisotropicBlur={0.08}
  distortion={0.15}
  distortionScale={0.4}
  temporalDistortion={0.02}
  backside
  backsideThickness={radius * 2}
  color={color}
  toneMapped={false}
/>
```

**Why `transmissionSampler`**: Without it, 18 spheres = 18 FBO passes = GPU meltdown. With it, 1 shared buffer. Trade-off: spheres can't see each other through glass — perfectly acceptable for scattered data points.

### Change 2: Pages — `planeGeometry` → `RoundedBox` with thickness

**Problem**: `planeGeometry` is infinitely thin — no visible edges when viewed at an angle, looks like a floating texture.

**Fix**: drei's `RoundedBox` gives pages 0.015-unit thickness with 0.004 radius rounded corners. When viewed at the current camera angle, the white side edges are visible = "real paper" depth.

```tsx
import { RoundedBox } from "@react-three/drei";

<RoundedBox args={[2.1, 2.97, 0.015]} radius={0.004} smoothness={4} castShadow>
  <meshStandardMaterial map={texture} color="#FFFFFF" roughness={0.92} ... />
</RoundedBox>
```

Remove `side={THREE.DoubleSide}` — `RoundedBox` has actual geometry for all faces.

### Change 3: Shadows — `ContactShadows` → `AccumulativeShadows` + `RandomizedLight`

**Problem**: `ContactShadows` produces hard-edged, flat shadows — doesn't match the mockup's soft studio-lighting look.

**Fix**: `AccumulativeShadows` with `RandomizedLight` — renders soft, raytraced-quality shadows over ~60 temporal frames, then costs zero ongoing GPU. Two light sources (key + fill) for natural shadow spread.

```tsx
import { AccumulativeShadows, RandomizedLight } from "@react-three/drei";

<AccumulativeShadows
  temporal
  frames={60}
  scale={12}
  position={[0, -2.0, 0]}
  opacity={0.5}
  color="#1A1A1A"
  alphaTest={0.85}
>
  <RandomizedLight amount={8} radius={5} position={[5, 8, -3]} bias={0.001} />
  <RandomizedLight amount={4} radius={3} position={[-3, 5, 4]} bias={0.001} />
</AccumulativeShadows>
```

### Import line (final)

```tsx
import {
  Float,
  Line,
  Environment,
  MeshTransmissionMaterial,
  RoundedBox,
  AccumulativeShadows,
  RandomizedLight,
} from "@react-three/drei";
```

`ContactShadows` removed.

---

## Performance Budget

| Element | Draw Calls | Notes |
|---------|------------|-------|
| 3 RoundedBox pages | 3 | Marginally more tris than planes |
| 18 spheres | 18 | Same geometry as before |
| Transmission pass | +1 | `transmissionSampler` = 1 shared FBO |
| AccumulativeShadows | +1 | Settles in ~60 frames then 0 cost |
| Axes + ticks | ~30 | Unchanged |
| **Total** | **~53** | Same budget as before |

---

## What stays unchanged

- Page fan positions, graph position/rotation, graph hover + breathe animations
- Per-group breathe config on spheres (frequency/phase/amplitude per colour)
- Axes with subtle breathe, scatter data points
- Canvas config, camera, procedural environment, reduced motion support
- `hero-section.tsx` — no changes needed

---

## Verification

1. `pnpm tsc --noEmit` — zero errors
2. Dev server hot reload — check localhost:3000
3. **Pages**: visible rounded edges/thickness on all 3 pages, white paper look
4. **Spheres**: true glass — see-through, rainbow chromatic aberration on edges, refraction
5. **Shadows**: soft, natural ground shadow (not hard-edged)
6. **Performance**: 30+ fps with Chrome DevTools 4x CPU throttle
7. `transmissionSampler` sanity: spheres refract the background/pages but not each other (expected)


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/devs/.REDACTED.jsonl

---

correct rotations to see the speheres better, better directional lighting, better pages.

---

[Image: source: REDACTED 2026-02-15 at 11.42.34 AM.png]

---

fix text on the pages, fix shadows for both elements. both shadows behind and beneath

---

Increase the view port for the 3d asset, so that the shadows can render? also the graph doesnt need a back shadow, only a below shadow, the pages lement needs both

---

[Image: source: REDACTED 2026-02-15 at 11.52.56 AM.png]

---

The cntainer width also needs to be increased as well, Thr Right pane brand and subtext will have lesser z or positive z and the container will have neg z so that brand and subtext comes in front on the overlap portion. The height also needs to increase more. Decresae the white space beneath the container to reduce gap from next element

---

I dont want these sharp shadow edges. also the graph is clipping on the right margin.

---

[Image: source: REDACTED 2026-02-15 at 11.59.51 AM.png]

---

Make the text on the pages , make them larger better font, and rotate the graph on the y axis by -35 deg

---

add arrowheads to axes ends, reduce tick sizes. Make the sharp inferior shadow border blend to bg

---

I mean the inferior border of the 3d container has a sharp shadow edge, that needs to blend to the bg below. But the shadow itslef should hold shape beneath the pages. Also place the graph a bit lower in the 3d container

---

[Image: source: REDACTED 2026-02-15 at 12.09.42 PM.png]

---

increase trasnparency on the glass speheres

---

revert these changes. I just want plain transparency increase. Also chnage the color profile of all the sperhes

---

different color set

---

Do berry garden

---

think of the colors on the page, the background, the paper, the text, and then think of color theory and which colored scatter plot would be best. then implement that. Think ultra hard before execution

---

Ok, now finally fix the shadows. Think of the 3d elements as solids with light source at top right corner of the 3d container. Think ultra hard, and implement the sahdow, which looks natural, with proper depth and color gradient, and avoid hard edges at the container limits. Remove the css blockade on the lower edge of the container if it exists

---

but it doesnt work properly. make the light source multiple  , instead of a point source, so tjht the shadows are not so sharp. I want soft shadows. Also make the glass sphere colors a bit darker

---

[Image: source: REDACTED 2026-02-15 at 12.33.53 PM.png]

---

The light sources need to number in 100s to have a natural soft tone shadow, not 5 or 10. Also for the glass spheres , i want more brighter deeper colors, not muted darker colors

---

see. no shadows at all, maybe too light?, also I want to rotate the graph another -1o deg on the y axis. and the spheres to be at diff z values, so as to create 3d space between them, not just x and y

---

[Image: source: REDACTED 2026-02-15 at 12.39.52 PM.png]

---

Still cant see the shadows!. the graph is almost perfect now

---

Horrendous shadow. Plan a fix. also increase the amount of text on the pages, especially page 1

---

[Image: source: REDACTED 2026-02-15 at 12.44.39 PM.png]

---

This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation.

Analysis:
Let me chronologically analyze the entire conversation:

1. **Initial Plan**: User provided a detailed plan for upgrading the hero 3D scene with three material/component swaps:
   - Glass spheres: `meshPhysicalMaterial` → `MeshTransmissionMaterial`
   - Pages: `planeGeometry` → `RoundedBox` with thickness
   - Shadows: `ContactShadows` → `AccumulativeShadows` + `RandomizedLight`

2. **First implementation**: Made all three swaps successfully. TypeScript passed.

3. **User feedback round 1**: "correct rotations to see spheres better, better directional lighting, better pages" - Screenshot showed washed out pages, scatter plot pushed to upper-right, flat lighting.
   - Fixed: Darkened page text, reduced ambient light, added rim light, adjusted scatter position/rotation, widened page fan spread.

4. **User feedback round 2**: "fix text on the pages, fix shadows for both elements. both shadows behind and beneath"
   - Text was still barely visible. AccumulativeShadows wasn't rendering.
   - Switched back to ContactShadows + added DropShadow radial gradient meshes for behind/beneath shadows.
   - Upgraded page texture to 1024x1440 with darker text. Created `createDropShadowTexture()` with radial gradient.

5. **User feedback round 3**: "Increase the viewport for the 3d asset, so that the shadows can render? also the graph doesnt need a back shadow, only a below shadow, the pages element needs both"
   - Page texture showed as diagonal hatching (RoundedBox UV mapping issue).
   - Changed hero-section.tsx container height from 520→640px.
   - Fixed page mesh: RoundedBox for body + separate planeGeometry for textured front face.
   - Removed graph back shadow.

6. **User feedback round 4**: "Right pane brand and subtext will have lesser z or positive z and the container will have neg z so that brand and subtext comes in front on the overlap portion"
   - Restructured layout: 3D pane absolutely positioned (75% width), left content zone gets `z-10`, height 740px, reduced bottom padding.

7. **User feedback round 5**: "I dont want these sharp shadow edges. also the graph is clipping on the right margin."
   - ContactShadows produced hard rectangular patches. Removed ContactShadows entirely.
   - Shifted scatter plot left (x: 0.5 → 0.0).
   - Enlarged DropShadow meshes, made gradient more gradual (6 stops).

8. **User feedback round 6**: "Make the text on the pages larger better font, and rotate the graph on the y axis by -35 deg"
   - Replaced rectangle text placeholders with real Canvas2D text rendering (Georgia serif titles, Helvetica body, word wrapping).
   - Added PAGE_CONTENT array with medical thesis content.
   - Set graph Y rotation to exactly -35 degrees.

9. **User feedback round 7**: "add arrowheads to axes ends, reduce tick sizes. Make the sharp inferior shadow border blend to bg"
   - Added AxisArrow component (cone geometry) at each axis tip.
   - TICK_SIZE halved from 0.05 to 0.025.
   - Shadow gradient made more gradual, shadow planes enlarged.

10. **User feedback round 8**: "the inferior border of the 3d container has a sharp shadow edge, that needs to blend to the bg below. But the shadow itself should hold shape beneath the pages. Also place the graph a bit lower"
    - Added CSS mask on 3D container: `maskImage: linear-gradient(to bottom, black 70%, transparent 100%)`
    - Moved graph down: position Y from -0.2 to -0.8.

11. **User feedback round 9**: "increase transparency on the glass spheres"
    - Over-engineered with many material property changes.

12. **User revert**: "revert these changes. I just want plain transparency increase. Also change the color profile of all the spheres"
    - Reverted to original material, only added `opacity={0.65}` + `transparent`.
    - User chose "Muted pastels" then "Nordic" then "Berry garden" colors.

13. **User feedback**: "think of the colors on the page, the background, the paper, the text, and then think of color theory"
    - Chose "natural materials" palette: `#6B8F71` (sage), `#C08B6B` (clay), `#7B9AAE` (dusty blue), `#C4A55A` (amber).

14. **User feedback round 10**: "fix the shadows. Think of the 3d elements as solids with light source at top right corner. Remove the css blockade on the lower edge"
    - Major shadow overhaul: Removed CSS mask, removed all DropShadow code, added ShadowMaterial ground plane, configured directional light shadow camera, added `shadows="soft"` to Canvas.

15. **User feedback round 11**: "it doesn't work properly. make the light source multiple, not 5 or 10, so the shadows are not so sharp. Also make the glass sphere colors a bit darker"
    - Replaced single light with 4 offset shadow-casting directional lights.
    - Darkened sphere colors.

16. **User feedback**: "The light sources need to number in 100s. Also brighter deeper colors"
    - Switched to AccumulativeShadows + RandomizedLight (120+40 samples).
    - Chose vivid colors: `#2D8C5A`, `#D4644A`, `#3A82B8`, `#D4A030`.
    - Set alphaTest=0.6, opacity=0.35.

17. **User feedback**: "Still can't see the shadows"
    - Fixed: Added `shadows` back to Canvas (was removed earlier, AccumulativeShadows needs it).

18. **User feedback**: "Horrendous shadow. Plan a fix. also increase the amount of text on the pages"
    - Screenshot shows massive dark block covering bottom of scene.
    - `alphaTest={0.3}` too low + `opacity={0.75}` too high = entire shadow plane visible as dark rectangle.
    - User entered plan mode.

Current state of shadows has been problematic throughout. Every approach has had issues:
- ContactShadows: hard rectangular edges
- DropShadow (radial gradients): not directional, hard plane edges
- ShadowMaterial: harsh sharp shadows
- AccumulativeShadows: either invisible or dark block

The current file state has AccumulativeShadows with opacity=0.75, alphaTest=0.3, which produces the dark block.

For page text: all 3 variants have only 3 body paragraphs each. User wants more, especially variant 0.

We were in plan mode exploring the codebase when the summary was requested.

Summary:
1. Primary Request and Intent:
   The user requested a polished upgrade of the React Three Fiber hero 3D scene (`hero-3d-scene.tsx`) for an academic thesis generation platform. The original plan had 3 material swaps: glass spheres (MeshTransmissionMaterial), paper pages with thickness (RoundedBox), and soft shadows (AccumulativeShadows). Over many iterations, the user refined requirements for: natural soft shadows, proper page text rendering, correct scatter plot positioning/rotation, sphere color selection, proper z-layering between text content and 3D scene, and viewport sizing. The most recent request is to fix the "horrendous" shadow (showing as a massive dark block) and increase text content on the pages.

2. Key Technical Concepts:
   - React Three Fiber (R3F) — `@react-three/fiber` Canvas, useFrame
   - drei components — `MeshTransmissionMaterial`, `RoundedBox`, `AccumulativeShadows`, `RandomizedLight`, `ContactShadows`, `Float`, `Line`, `Environment`
   - Canvas2D texture generation for page content with word wrapping
   - Shadow techniques: ContactShadows, AccumulativeShadows+RandomizedLight, ShadowMaterial ground plane, radial gradient DropShadow meshes, multi-light shadow simulation
   - CSS z-index layering for 3D canvas behind text content
   - CSS mask-image for container edge fading (later removed)
   - Three.js SphereGeometry, planeGeometry, coneGeometry
   - `shadows` prop on Canvas required for AccumulativeShadows to function
   - Colour theory for sphere palette selection against warm cream background

3. Files and Code Sections:

   - **`apps/web/components/landing/hero-3d-scene.tsx`** (main file, heavily modified)
     - Core 3D scene with thesis pages, scatter plot with glass spheres, axes with arrowheads
     - Current shadow system (broken): AccumulativeShadows with opacity=0.75, alphaTest=0.3 producing dark block
     - Current sphere colors: `["#2D8C5A", "#D4644A", "#3A82B8", "#D4A030"]` (vivid emerald, coral, cerulean, golden amber)
     - Current graph rotation: `[0.1, -45 * (Math.PI / 180), 0.15]`, position `[0.0, -0.8, 1.5]`
     - Page mesh uses RoundedBox (white body) + separate planeGeometry (textured front face at z=0.0076)
     - PAGE_CONTENT has 3 variants with 3 body paragraphs each — user wants MORE text, especially variant 0
     - Canvas has `shadows` prop enabled
     - Current imports: `Float, Line, Environment, MeshTransmissionMaterial, RoundedBox, AccumulativeShadows, RandomizedLight`
     
     Current shadow config (THE PROBLEM):
     ```tsx
     <AccumulativeShadows
       temporal
       frames={120}
       scale={18}
       position={[0, -2.2, 0]}
       opacity={0.75}
       color="#2A2520"
       alphaTest={0.3}
     >
       <RandomizedLight amount={120} radius={8} position={[4, 8, 3]} bias={0.001} mapSize={1024} />
       <RandomizedLight amount={40} radius={5} position={[-3, 6, 4]} bias={0.001} mapSize={512} />
     </AccumulativeShadows>
     ```

     Current lighting:
     ```tsx
     <ambientLight intensity={0.5} />
     <directionalLight position={[4, 8, 3]} intensity={1.8} />
     <pointLight position={[-4, 4, 3]} intensity={0.6} color="#FFF5E6" />
     <pointLight position={[2, -2, 5]} intensity={0.3} color="#F5F0E8" />
     <directionalLight position={[-3, 2, -4]} intensity={0.8} color="#E8ECF0" />
     ```

   - **`apps/web/components/landing/hero-section.tsx`** (layout wrapper)
     - 3D container: `pointer-events-none absolute -right-12 top-0 hidden h-[740px] w-[75%] lg:block`
     - CSS mask was removed (no longer has maskImage)
     - Left content zone: `relative z-10 flex min-h-[740px] flex-col justify-center lg:max-w-[45%]`
     - Section: `relative overflow-hidden pb-2 pt-28 lg:pb-4 lg:pt-32`

4. Errors and Fixes:
   - **RoundedBox UV mapping distortion**: Texture applied to RoundedBox rendered as diagonal hatching. Fixed by using RoundedBox for white body + separate planeGeometry for textured front face.
   - **AccumulativeShadows invisible (alphaTest=0.85)**: Too aggressive filtering. Lowering alphaTest helped but then caused dark block.
   - **AccumulativeShadows invisible (no `shadows` on Canvas)**: Removed `shadows` prop from Canvas, forgetting AccumulativeShadows requires it. Fixed by adding `shadows` back.
   - **AccumulativeShadows dark block (alphaTest=0.3, opacity=0.75)**: Too low alphaTest includes faint shadow noise across entire plane, high opacity makes it all visible as dark rectangle. THIS IS THE CURRENT UNSOLVED PROBLEM.
   - **ContactShadows hard rectangular edges**: The shadow plane boundaries were visible. Was addressed by switching to DropShadow radial gradients, then to AccumulativeShadows.
   - **Sphere transparency over-engineering**: User said "revert these changes. I just want plain transparency increase" — reverted all material changes, only added `opacity={0.65}` + `transparent`.
   - **Edit tool string matching failures**: Multiple times the old_string didn't match due to trailing dash counts in comment lines or whitespace differences. Fixed by re-reading exact file content or using Write tool.
   - **pnpm tsc run from wrong directory**: Initially ran from monorepo root, needed to run from `apps/web/`.

5. Problem Solving:
   - **Shadow system**: Has been the persistent unsolved problem throughout the conversation. Every approach has failed:
     - ContactShadows → hard rectangular edges
     - DropShadow radial gradient meshes → not directional, hard plane edges at container boundary
     - CSS mask to hide edges → hack that faded everything including content
     - ShadowMaterial ground plane → sharp harsh single-source shadows
     - Multi-light simulation (4 lights) → still too sharp
     - AccumulativeShadows → either invisible or massive dark block
   - **Page text**: Evolved from rounded rectangles → darker rounded rectangles → real Canvas2D text with Georgia/Helvetica fonts and word wrapping. Currently needs more content.
   - **Scatter plot positioning**: Gradually adjusted through multiple rounds to avoid clipping and improve visibility.

6. All User Messages:
   - "Implement the following plan: Hero 3D Scene — Polished R3F Material Upgrade" (detailed plan with 3 changes)
   - "correct rotations to see the spheres better, better directional lighting, better pages." [with screenshot]
   - "fix text on the pages, fix shadows for both elements. both shadows behind and beneath"
   - "Increase the view port for the 3d asset, so that the shadows can render? also the graph doesnt need a back shadow, only a below shadow, the pages element needs both" [with screenshot]
   - "Right pane brand and subtext will have lesser z or positive z and the container will have neg z so that brand and subtext comes in front on the overlap portion. The height also needs to increase more. Decrease the white space beneath the container to reduce gap from next element"
   - "I dont want these sharp shadow edges. also the graph is clipping on the right margin." [with screenshot]
   - "Make the text on the pages, make them larger better font, and rotate the graph on the y axis by -35 deg"
   - "add arrowheads to axes ends, reduce tick sizes. Make the sharp inferior shadow border blend to bg"
   - "I mean the inferior border of the 3d container has a sharp shadow edge, that needs to blend to the bg below. But the shadow itself should hold shape beneath the pages. Also place the graph a bit lower in the 3d container" [with screenshot]
   - "increase transparency on the glass spheres"
   - "revert these changes. I just want plain transparency increase. Also change the color profile of all the spheres"
   - "different color set"
   - "Do berry garden"
   - "think of the colors on the page, the background, the paper, the text, and then think of color theory and which colored scatter plot would be best. then implement that. Think ultra hard before execution"
   - "Ok, now finally fix the shadows. Think of the 3d elements as solids with light source at top right corner of the 3d container. Think ultra hard, and implement the shadow, which looks natural, with proper depth and color gradient, and avoid hard edges at the container limits. Remove the css blockade on the lower edge of the container if it exists"
   - "but it doesnt work properly. make the light source multiple, instead of a point source, so that the shadows are not so sharp. I want soft shadows. Also make the glass sphere colors a bit darker" [with screenshot]
   - "The light sources need to number in 100s to have a natural soft tone shadow, not 5 or 10. Also for the glass spheres, i want more brighter deeper colors, not muted darker colors"
   - "Still cant see the shadows! The graph is almost perfect now"
   - "see. no shadows at all, maybe too light?, also I want to rotate the graph another -10 deg on the y axis. and the spheres to be at diff z values, so as to create 3d space between them, not just x and y" [with screenshot]
   - "Horrendous shadow. Plan a fix. also increase the amount of text on the pages, especially page 1" [with screenshot showing dark block]

7. Pending Tasks:
   - **Fix shadows** — AccumulativeShadows currently produces a massive dark block. Need a working soft shadow solution.
   - **Increase page text content** — All 3 PAGE_CONTENT variants have only 3 body paragraphs. User wants more text, especially on page 1 (variant 0, "Introduction").

8. Current Work:
   We entered plan mode to design a shadow fix. The user said "Horrendous shadow. Plan a fix. also increase the amount of text on the pages, especially page 1" with a screenshot showing AccumulativeShadows rendering as a massive near-opaque dark rectangle covering the bottom third of the scene.
   
   An Explore agent was dispatched and confirmed:
   - AccumulativeShadows has `opacity={0.75}`, `alphaTest={0.3}`, `scale={18}`
   - All 3 PAGE_CONTENT variants have exactly 3 body paragraphs
   - Canvas has `shadows` enabled
   - Pages at y=0, scatter at y=-0.8, shadow plane at y=-2.2

   We were in Phase 1 of the plan workflow when the summary was requested.

9. Optional Next Step:
   Continue planning the shadow fix in plan mode. The user's exact words were: "Horrendous shadow. Plan a fix. also increase the amount of text on the pages, especially page 1"
   
   The shadow fix needs to find the right AccumulativeShadows parameters (the sweet spot between invisible and dark block), or use an entirely different approach like ContactShadows with large scale + high blur to avoid edge visibility issues. The page text needs more paragraphs added to PAGE_CONTENT, especially variant 0.

If you need specific details from before compaction (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/devs/.REDACTED.jsonl
Please continue the conversation from where we left off without asking the user any further questions. Continue with the last task that you were asked to work on.

---

[Request interrupted by user for tool use]