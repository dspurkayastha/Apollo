services:
  # Web: run Next.js dev server on the host, not in Docker.
  # Use `pnpm dev` in apps/web/ and set LATEX_COMPILE_MODE=docker.

  latex:
    # NOTE: This container is NOT used for compilation.
    # compile.ts uses `docker run --rm apollo-latex` (ephemeral containers).
    # Compilation security settings are in apps/web/lib/latex/compile.ts.
    # Security settings here apply to the sleeping container only.
    build:
      context: ..
      dockerfile: docker/Dockerfile.latex
    image: apollo-latex
    container_name: apollo-latex
    network_mode: none
    read_only: true
    tmpfs:
      - /tmp:rw,size=512m
    mem_limit: 1g
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
      - seccomp:./seccomp-latex.json
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
      - FOWNER
    # Container stays idle; web app exec's into it per compile
    entrypoint: ["sleep", "infinity"]
    volumes:
      - ../templates:/templates:ro

  r-plumber:
    build:
      context: ..
      dockerfile: docker/Dockerfile.r-plumber
    image: apollo-r-plumber
    container_name: apollo-r-plumber
    read_only: true
    tmpfs:
      - /tmp:rw,size=256m
    mem_limit: 512m
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
      # Using Docker's default seccomp (blocks ~44 dangerous syscalls).
      # Custom seccomp-r.json was too restrictive for R/bash startup.
      # Security: cap_drop:ALL + read_only + AppArmor + no-new-privileges.
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
      - FOWNER
      - NET_BIND_SERVICE
    ports:
      - "127.0.0.1:8787:8787"
    environment:
      - R_PLUMBER_SECRET=${R_PLUMBER_SECRET:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8787/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
