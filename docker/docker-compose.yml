version: "3.8"

services:
  # Web: run Next.js dev server on the host, not in Docker.
  # Use `pnpm dev` in apps/web/ and set LATEX_COMPILE_MODE=docker.

  latex:
    build:
      context: ..
      dockerfile: docker/Dockerfile.latex
    container_name: apollo-latex
    network_mode: none
    read_only: true
    tmpfs:
      - /tmp:rw,size=512m
    mem_limit: 1g
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
      - FOWNER
    # Container stays idle; web app exec's into it per compile
    entrypoint: ["sleep", "infinity"]
    volumes:
      - ../templates:/templates:ro

  r-plumber:
    build:
      context: ..
      dockerfile: docker/Dockerfile.r-plumber
    container_name: apollo-r-plumber
    read_only: true
    tmpfs:
      - /tmp:rw,size=256m
    mem_limit: 512m
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
      - FOWNER
      - NET_BIND_SERVICE
    ports:
      - "8787:8787"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8787/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
